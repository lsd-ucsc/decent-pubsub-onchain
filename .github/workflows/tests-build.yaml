name: Build test for tests contracts


on:
  push:
    branches: [ main ]
    paths:
      - 'PubSub/**'
      - 'tests/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'PubSub/**'
      - 'tests/**'


jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        node-version: [18.16.0]
        solc-version: [0.8.19]
    name: A job to build tests contracts
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Installing Node ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    - name: Installing solc compiler
      run: |
        npm install -g solc@${{ matrix.solc-version }}

    - name: Compiling contracts for tests/HelloWorldSubscriber.sol
      run: |
        solcjs  --optimize --optimize-runs 200 --bin --include-path node_modules/ --base-path . --output-dir ./build/ ./tests/HelloWorldSubscriber.sol
        solcjs  --optimize --optimize-runs 200 --abi --include-path node_modules/ --base-path . --output-dir ./build/ ./tests/HelloWorldSubscriber.sol

    - name: Compiling contracts for tests/HelloWorldPublisher.sol
      run: |
        solcjs  --optimize --optimize-runs 200 --bin --include-path node_modules/ --base-path . --output-dir ./build/ ./tests/HelloWorldPublisher.sol
        solcjs  --optimize --optimize-runs 200 --abi --include-path node_modules/ --base-path . --output-dir ./build/ ./tests/HelloWorldPublisher.sol

    - name: Renaming built binary and abi
      run: |
        mv ./build/tests_HelloWorldSubscriber_sol_HelloWorldSubscriber.bin ./build/HelloWorldSubscriber.bin
        mv ./build/tests_HelloWorldSubscriber_sol_HelloWorldSubscriber.abi ./build/HelloWorldSubscriber.abi
        mv ./build/tests_HelloWorldPublisher_sol_HelloWorldPublisher.bin   ./build/HelloWorldPublisher.bin
        mv ./build/tests_HelloWorldPublisher_sol_HelloWorldPublisher.abi   ./build/HelloWorldPublisher.abi

    - name: Calculating checksums of the binary
      run: |
        sha256sum ./build/HelloWorldSubscriber.bin >> ./build/checksums.txt
        sha256sum ./build/HelloWorldSubscriber.abi >> ./build/checksums.txt
        sha256sum ./build/HelloWorldPublisher.bin  >> ./build/checksums.txt
        sha256sum ./build/HelloWorldPublisher.abi  >> ./build/checksums.txt

    - name: Print checksums
      run: |
        cat ./build/checksums.txt
